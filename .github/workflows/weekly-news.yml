# ============================================================
# å¡—è£…æ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•ã¾ã¨ã‚ãƒ„ãƒ¼ãƒ« â€” GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ============================================================
# æ¯Žé€±æœˆæ›œ 08:00 JST (æ—¥æ›œ 23:00 UTC) ã«è‡ªå‹•å®Ÿè¡Œ
# æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ï¼ˆworkflow_dispatchï¼‰

name: Weekly Paint Industry News

on:
  # å®šæœŸå®Ÿè¡Œ: æ¯Žé€±æœˆæ›œ 08:00 JST = æ—¥æ›œ 23:00 UTC
  schedule:
    - cron: '0 23 * * 0'

  # æ‰‹å‹•å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_email:
        description: 'ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡: å‰å›žã®å®Ÿè¡ŒãŒçµ‚ã‚ã‚‹ã¾ã§å¾…æ©Ÿ
concurrency:
  group: weekly-news
  cancel-in-progress: false

permissions:
  contents: write
  pages: write

jobs:
  generate-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run news pipeline
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          GITHUB_PAGES_BASE_URL: ${{ secrets.GITHUB_PAGES_BASE_URL }}
          LOG_LEVEL: INFO
        run: |
          # ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®æ§‹ç¯‰
          ARGS=""

          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³åˆ¤å®š
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š
          if [ "${{ github.event.inputs.skip_email }}" = "true" ]; then
            ARGS="$ARGS --no-email"
          fi

          python -m scripts.main $ARGS

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # docs/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸
          git add docs/

          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(TZ='Asia/Tokyo' date +%Y-%m-%d)
            git commit -m "ðŸ“° Weekly news report: ${DATE}"
            git push
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Job summary
        if: always()
        run: |
          echo "## ðŸŽ¨ å¡—è£…æ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹ç”Ÿæˆçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "docs" ]; then
            FILE_COUNT=$(ls docs/weekly-news-*.html 2>/dev/null | wc -l)
            echo "- ðŸ“„ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${FILE_COUNT}" >> $GITHUB_STEP_SUMMARY

            LATEST=$(ls -t docs/weekly-news-*.html 2>/dev/null | head -1)
            if [ -n "$LATEST" ]; then
              echo "- ðŸ“ æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆ: \`$(basename $LATEST)\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âš ï¸ docs/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_å®Ÿè¡Œæ™‚åˆ»: $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')_" >> $GITHUB_STEP_SUMMARY
